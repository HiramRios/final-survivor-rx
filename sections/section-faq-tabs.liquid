{%- liquid
  assign bg_color = section.settings.bg_color
  assign text_color = section.settings.text_color
  assign animation_anchor = '#FaqTabs--' | append: section.id

  assign tabs_string = ''
  for block in section.blocks
    assign t = block.settings.tab | strip
    unless tabs_string contains t
      assign tabs_string = tabs_string | append: t | append: '||'
    endunless
  endfor
  assign tabs = tabs_string | split: '||' | compact
-%}

{%- if section.blocks.size > 0 -%}
  {%- style -%}
    {{ section.settings.heading_font | font_face }}
    {{ section.settings.question_font | font_face }}
    #FaqTabs--{{ section.id }}{
      --PT: {{ section.settings.padding_top }}px;
      --PB: {{ section.settings.padding_bottom }}px;
      --card-bg: #fff;
      --card-radius: 14px;
      --card-shadow: 0 1px 0 rgba(0,0,0,.04), 0 6px 16px rgba(0,0,0,.06);
      --tab-accent: #1d6a3a;
      --muted: #6b7280;
      --heading-font-family: {{ section.settings.heading_font.family }}, {{ section.settings.heading_font.fallback_families }};
      --heading-font-weight: {{ section.settings.heading_font.weight }};
      --heading-font-style: {{ section.settings.heading_font.style }};
      --heading-font-size: {{ section.settings.heading_font_size }}px;
      --question-font-family: {{ section.settings.question_font.family }}, {{ section.settings.question_font.fallback_families }};
      --question-font-weight: {{ section.settings.question_font.weight }};
      --question-font-style: {{ section.settings.question_font.style }};
      --question-font-size: {{ section.settings.question_font_size }}px;
      {%- unless bg_color == 'rgba(0,0,0,0)' or bg_color == blank -%}
        --bg: {{ bg_color }};
      {%- endunless -%}
      {%- unless text_color == 'rgba(0,0,0,0)' or text_color == blank -%}
        --text: {{ text_color }};
      {%- endunless -%}
    }

    #FaqTabs--{{ section.id }} .faq__inner{
      max-width: 980px;
      margin-inline: auto;
    }

    #FaqTabs--{{ section.id }}.faq{
      padding-top: var(--PT);
      padding-bottom: var(--PB);
      background: var(--bg, transparent);
      color: var(--text, inherit);
    }

    #FaqTabs--{{ section.id }} .faq__title{
      text-align: center;
      margin: 0 0 .25rem;
      font-size: var(--heading-font-size);
      line-height: 1.15;
      font-family: var(--heading-font-family);
      font-weight: var(--heading-font-weight);
      font-style: var(--heading-font-style);
    }
    #FaqTabs--{{ section.id }} .faq__subtitle{
      text-align: center;
      margin: 0 0 1.75rem;
      font-size: 14px;
      color: var(--muted);
    }

    /* Tabs header */
    #FaqTabs--{{ section.id }} .faq-tabs__head{
      display: grid;
      grid-auto-columns: 1fr;
      grid-auto-flow: column;
      gap: clamp(10px,2vw,24px);
      list-style: none;
      padding: 0;
      margin: 0 0 18px;
      justify-items: center;
      border-bottom: 1px solid rgba(0,0,0,.06);
    }
    #FaqTabs--{{ section.id }} .faq-tabs__head .tab-link{
      position: relative;
      padding: 14px 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 16px;
      color: #1f2937;
      outline: none;
      transition: color .2s ease;
      white-space: nowrap;
    }
    #FaqTabs--{{ section.id }} .faq-tabs__head .tab-link.current{ color: #0f172a; }
    #FaqTabs--{{ section.id }} .faq-tabs__head .tab-link.current::after{
      content: "";
      position: absolute;
      left: 0; right: 0; bottom: -1px;
      height: 3px;
      background: var(--tab-accent);
      border-radius: 3px 3px 0 0;
    }
    #FaqTabs--{{ section.id }} .faq-tabs__head .tab-link:focus-visible{
      box-shadow: 0 0 0 3px rgba(29,106,58,.25);
      border-radius: 8px;
    }

    /* Tab content switch */
    #FaqTabs--{{ section.id }} .tab-content{ display: none; }
    #FaqTabs--{{ section.id }} .tab-content.current{ display: block; }

    /* Accordion cards */
    #FaqTabs--{{ section.id }} .faq-list{
      display: grid;
      gap: 12px;
      margin-top: 8px;
    }
    .faq-list{
      justify-content: normal !important;
    }
    #FaqTabs--{{ section.id }} details.accordion{
      background: var(--card-bg);
      border-radius: var(--card-radius);
      box-shadow: var(--card-shadow);
      overflow: hidden;
    }
    #FaqTabs--{{ section.id }} summary.accordion__title{
      list-style: none;
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: center;
      gap: 16px;
      padding: 18px 20px;
      cursor: pointer;
      position: relative;
      font-size: var(--question-font-size);
      font-family: var(--question-font-family);
      font-weight: var(--question-font-weight);
      font-style: var(--question-font-style);
    }
    #FaqTabs--{{ section.id }} summary.accordion__title::-webkit-details-marker{ display:none; }

    /* Chevron */
    #FaqTabs--{{ section.id }} .chev{
      width: 18px; height: 18px;
      transition: transform .25s ease;
      opacity: .85;
    }
    #FaqTabs--{{ section.id }} details[open] .chev{ transform: rotate(180deg); }

    /* Body */
    #FaqTabs--{{ section.id }} .accordion__body{
      padding: 0 20px 18px 20px;
      color: #334155;
      font-size: 15px;
      line-height: 1.6;
      border-top: 1px solid rgba(0,0,0,.06);
    }

    /* Footer link */
    #FaqTabs--{{ section.id }} .faq__footer{
      text-align: center;
      margin-top: 18px;
    }
    #FaqTabs--{{ section.id }} .faq__cta{
      font-weight: 600;
      text-decoration: underline;
      text-underline-offset: 3px;
      color: #0f172a;
    }

    /* Responsive */
    @media (max-width: 720px){
      #FaqTabs--{{ section.id }} .faq-tabs__head{
        grid-auto-flow: row;
        grid-template-columns: 1fr 1fr;
        justify-items: start;
      }
      #FaqTabs--{{ section.id }} .faq-tabs__head .tab-link{ width: 100%; }
    }
  {%- endstyle -%}

  <section id="FaqTabs--{{ section.id }}" class="faq" data-section-id="{{ section.id }}" data-section-type="faq-tabs" data-aos="hero" data-aos-anchor="{{ animation_anchor }}">
    <div class="{{ section.settings.width }}">
      <div class="faq__inner">
        {%- if section.settings.heading != blank -%}
          <h2 class="faq__title" data-aos="hero" data-aos-order="1" data-aos-anchor="{{ animation_anchor }}">{{ section.settings.heading }}</h2>
        {%- endif -%}
        {%- if section.settings.subheading != blank -%}
          <p class="faq__subtitle">{{ section.settings.subheading }}</p>
        {%- endif -%}

        <faq-tabs class="faq-tabs" data-tabs-holder>
          <ul class="faq-tabs__head" role="tablist">
            {%- for tab in tabs -%}
              <li
                class="tab-link tab-link-{{ forloop.index0 }}{% if forloop.first %} current{% endif %}"
                data-tab="{{ forloop.index0 }}"
                id="tab-{{ section.id }}-{{ forloop.index0 }}"
                role="tab"
                aria-selected="{% if forloop.first %}true{% else %}false{% endif %}"
                aria-controls="panel-{{ section.id }}-{{ forloop.index0 }}"
                tabindex="0">
                <span>{{ tab }}</span>
              </li>
            {%- endfor -%}
          </ul>

          {%- for tab in tabs -%}
            <div
              class="tab-content tab-content-{{ forloop.index0 }}{% if forloop.first %} current{% endif %}"
              id="panel-{{ section.id }}-{{ forloop.index0 }}"
              role="tabpanel"
              aria-labelledby="tab-{{ section.id }}-{{ forloop.index0 }}"
              data-tab-index="{{ forloop.index0 }}"
            >
              <div class="faq-list">
                {%- for block in section.blocks -%}
                  {%- if block.settings.tab == tab -%}
                    <div class="faq-list__item" {{ block.shopify_attributes }}>
                      <details class="accordion" data-collapsible>
                        <summary class="accordion__title">
                          <span>{{ block.settings.question }}</span>
                          <!-- chevron -->
                          <svg class="chev" viewBox="0 0 20 20" aria-hidden="true">
                            <path d="M5.5 7.5 10 12l4.5-4.5" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"/>
                          </svg>
                        </summary>
                        <div class="accordion__body rte">
                          <div class="accordion__content">
                            {{ block.settings.answer }}
                          </div>
                        </div>
                      </details>
                    </div>
                  {%- endif -%}
                {%- endfor -%}
              </div>
            </div>
          {%- endfor -%}
        </faq-tabs>

        {%- if section.settings.cta_label != blank and section.settings.cta_link != blank -%}
          <div class="faq__footer">
            <a class="faq__cta" href="{{ section.settings.cta_link }}">{{ section.settings.cta_label }}</a>
          </div>
        {%- endif -%}
      </div>
    </div>
  </section>

  <script>
    class FaqTabs extends HTMLElement {
      connectedCallback() {
        this.head = this.querySelector('.faq-tabs__head');
        this.links = this.querySelectorAll('.tab-link');
        this.panels = this.querySelectorAll('.tab-content');

        this.links.forEach((link) => {
          link.addEventListener('click', () => this.switchTab(link.dataset.tab));
          link.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); this.switchTab(link.dataset.tab); }
            if (e.key === 'ArrowRight' || e.key === 'ArrowDown') { e.preventDefault(); this.focusNext(link); }
            if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') { e.preventDefault(); this.focusPrev(link); }
          });
        });

        // One-open-at-a-time per panel
        this.panels.forEach(panel => {
          panel.querySelectorAll('details.accordion').forEach(d => {
            d.addEventListener('toggle', () => {
              if (d.open) {
                panel.querySelectorAll('details.accordion').forEach(other => { if (other !== d) other.removeAttribute('open'); });
              }
            });
          });
        });
      }

      switchTab(index) {
        this.links.forEach((l) => {
          const active = l.dataset.tab === String(index);
          l.classList.toggle('current', active);
          l.setAttribute('aria-selected', active ? 'true' : 'false');
        });
        this.panels.forEach((p) => {
          p.classList.toggle('current', p.dataset.tabIndex === String(index));
          p.hidden = !(p.dataset.tabIndex === String(index));
        });
      }

      focusNext(current) {
        const arr = Array.from(this.links);
        const i = arr.indexOf(current);
        const next = arr[(i + 1) % arr.length];
        next.focus();
      }

      focusPrev(current) {
        const arr = Array.from(this.links);
        const i = arr.indexOf(current);
        const prev = arr[(i - 1 + arr.length) % arr.length];
        prev.focus();
      }
    }
    customElements.define('faq-tabs', FaqTabs);
  </script>
{%- endif -%}

{% schema %}
{
  "name": "FAQ tabs",
  "tag": "section",
  "class": "section-faq-tabs",
  "settings": [
    { "type": "text", "id": "heading", "label": "Heading", "default": "Questions & Answers" },
    { "type": "text", "id": "subheading", "label": "Subheading", "default": "Find answers to the most frequently asked questions" },
    {
      "type": "select",
      "id": "width",
      "label": "Layout width",
      "options": [
        { "value": "wrapper", "label": "Default" },
        { "value": "wrapper--narrow", "label": "Narrow" },
        { "value": "wrapper--full", "label": "Full width" }
      ],
      "default": "wrapper"
    },
    { "type": "url", "id": "cta_link", "label": "Footer link (optional)" },
    { "type": "text", "id": "cta_label", "label": "Footer link label", "default": "Got more questions?" },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0, "max": 120, "step": 4, "unit": "px",
      "label": "Padding top", "default": 36
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0, "max": 120, "step": 4, "unit": "px",
      "label": "Padding bottom", "default": 36
    },
    { "type": "color", "id": "bg_color", "label": "Background color", "default": "#F7F7F7" },
    { "type": "color", "id": "text_color", "label": "Text color", "default": "#0f172a" },
    { "type": "font_picker", "id": "heading_font", "label": "Heading font", "default": "poppins_n7" },
    { "type": "range", "id": "heading_font_size", "min": 16, "max": 80, "step": 1, "unit": "px", "label": "Heading font size", "default": 32 },
    { "type": "font_picker", "id": "question_font", "label": "Question font", "default": "poppins_n5" },
    { "type": "range", "id": "question_font_size", "min": 12, "max": 40, "step": 1, "unit": "px", "label": "Question font size", "default": 16 }
  ],
  "blocks": [
    {
      "type": "faq",
      "name": "Question",
      "settings": [
        { "type": "text", "id": "tab", "label": "Tab title", "default": "General Questions" },
        { "type": "text", "id": "question", "label": "Question", "default": "Sample question?" },
        { "type": "richtext", "id": "answer", "label": "Answer", "default": "<p>Sample answer content goes here.</p>" }
      ]
    }
  ],
  "presets": [
    {
      "name": "FAQ tabs",
      "blocks": [
        { "type": "faq", "settings": { "tab": "General Questions", "question": "How long after my cancer treatment can I start?", "answer": "<p>Always check with your physician first.</p>" } },
        { "type": "faq", "settings": { "tab": "General Questions", "question": "Will this increase testosterone?", "answer": "<p>No, this product is not formulated to alter testosterone.</p>" } },
        { "type": "faq", "settings": { "tab": "Cancer Survivor Support", "question": "Do I need a history of cancer?", "answer": "<p>No. This is formulated for overall prostate support.</p>" } },
        { "type": "faq", "settings": { "tab": "Subscription Management", "question": "Can I cancel or change my subscription?", "answer": "<p>Yesâ€”manage anytime from your account portal.</p>" } }
      ]
    }
  ]
}
{% endschema %}